name: "PyAnnote-Api-Toolkit"

services:
  mongodb:
    build: ./backend/mongo
    image: mongo:8.0
    volumes:
      - mongo-data:/data/db
      - mongo-config:/data/configdb
    environment:
      MONGO_INITDB_DATABASE: pyannote_api_infos
    restart: unless-stopped
    networks:
      - mongo-network

  pyannote-wrapper:
    build: ./backend/pyannote-wrapper
    environment:
      API_HOST: 0.0.0.0
      API_PORT: 5001
      TOKEN_PYANNOTE: ${TOKEN_PYANNOTE?TOKEN_PYANNOTE must be set!}
      WEBHOOK_URI: https://${NGROK_SUBDOMAIN?NGROK_SUBDOMAIN must be set!}/webhook
    networks:
      - backend-network

  mongo-gateway:
    build: ./backend/mongo-gateway
    environment:
      API_HOST: 0.0.0.0
      API_PORT: 5002
      MONGO_URI: mongodb://mongodb:27017/
      MONGO_DATABASE: pyannote_api_infos
    depends_on: 
      - mongodb
    networks:
      - backend-network
      - mongo-network

  webhook:
    build: ./backend/webhook
    environment:
      API_HOST: 0.0.0.0
      API_PORT: 5003
      PYANNOTEAI_WEBHOOK_SIGNING_SECRET: ${PYANNOTEAI_WEBHOOK_SIGNING_SECRET?PYANNOTEAI_WEBHOOK_SIGNING_SECRET must be set!}
      API_SERVER_HOST: api-server
      API_SERVER_PORT: 5000
    networks:
      - webhook-network
      - backend-network

  ngrok:
    image: ngrok/ngrok:latest
    command:
      - "http"
      - "http://webhook:5003" 
    environment:
      NGROK_AUTHTOKEN: ${NGROK_AUTH_TOKEN}
    depends_on:
      - webhook
    networks:
      - webhook-network

  api-server:
    build: ./backend/api-server
    environment:
      API_HOST: 0.0.0.0
      API_PORT: 5000
      PYANNOTE_WRAPPER_HOST: pyannote-wrapper
      PYANNOTE_WRAPPER_PORT: 5001
      MONGO_GATEWAY_HOST: mongo-gateway
      MONGO_GATEWAY_PORT: 5002
    depends_on:
      - mongodb
      - pyannote-wrapper
      - mongo-gateway
      - webhook
    networks:
      - frontend-network
      - backend-network
      - webhook-network

  frontend:
    build: ./frontend
    ports:
      - "8080:80"
    depends_on:
     - mongodb
     - pyannote-wrapper
     - mongo-gateway
     - api-server
     - webhook
    networks:
      - frontend-network


volumes:
  mongo-data:
    name: "mongo-data"
  mongo-config:
    name: "mongo-config"

networks:
  frontend-network:
    driver: bridge
  backend-network:
    driver: bridge
  mongo-network:
    driver: bridge
  webhook-network:
    driver: bridge
